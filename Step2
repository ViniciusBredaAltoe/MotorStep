#include <Stepper.h>

#define STEPS 100
#define motorspeed 30 // set the speed of the motor to 30 RPMs


Stepper stepper(STEPS, 8, 9, 10, 11);


// =============================================================== Acerto da Pinagem ======================================================

const int fcr = 22; // Fim de curso Right
const int fcl = 24; // Fim de curso Left
const int botton_mode = 52;
const int botton_right = 50;
const int botton_go = 48;
const int botton_left = 46;


// =============================================================== Variaveis Externas =====================================================

const int resolution = 2; //Averiguar!!
const int velocidade_botton = 1000;
// =============================================================== Variáveis Internas =====================================================

int right;
int left;
int go;
int bmode;

int locus; // Destino desejado
int posicao; // Posição atual
int Max; // Distancia máxima da origem [mm]
int mode; // Modo de operação (0, 1 ou 2)

// =============================================================== Variáveis de Status ====================================================

int status1;
int status_br;
int status_go;
int status_bl;
int status_mode;

// =================================================================== VOID SETUP =========================================================

void setup() {
  pinMode(fcr, INPUT_PULLUP);
  pinMode(fcl, INPUT_PULLUP);
  pinMode(botton_right, INPUT_PULLUP);
  pinMode(botton_go, INPUT_PULLUP);
  pinMode(botton_left, INPUT_PULLUP);
  pinMode(botton_mode, INPUT_PULLUP);

  stepper.setSpeed(motorspeed);
  int status1 = 0;

  Serial.begin(9600); // TEST PROTOBOARD
}

// ================================================================= INICIALIZAÇÃO ========================================================

int Initialization()
{
  int Dmax;
  int cont = 0;
  while (digitalRead(fcr) == HIGH)
  {
    //stepper.step(1); // Vai para a direita
    Serial.print("Inicialização Direita \n"); // TEST PROTOBOARD
    delay(1000); // TEST PROTOBOARD

  }
  while (digitalRead(fcl) == HIGH)
  {
    //stepper.step(-1); // Vai para a esquerda
    cont++;
    Serial.print("Inicialização Esquerda  \n"); // TEST PROTOBOARD
    delay(1000); // TEST PROTOBOARD
  }
  //Printar Cont
  Dmax = cont * resolution;
  return Dmax;
}

// ================================================================== BOTAO STATUS =======================================================

int botton_status (int botton, int status_botton)
{
  status_botton = digitalRead(botton);
  if (status_botton != HIGH)
  {
    delay(50);
    if (status_botton == LOW) {
      status_botton = 0;
    }

  }
  return status_botton;
}

// ===================================================================== VOID LOOP =======================================================

void loop()
{
  if (status1 == 0) // Verifica se a inicialização ja foi feita (0 = sim e 1 = não)
  {
    Max = Initialization();
    Serial.print("A distancia máxima da origem é: "); // TEST PROTOBOARD
    Serial.print(Max); // TEST PROTOBOARD
    Serial.print("\n"); // TEST PROTOBOARD
    mode = 0;
    status1 = 1;
    right = 1;
    left = 1;
    go = 1;
    bmode = 0;
  }

  if ((right + left + go + bmode) == 3)
  {
    if (bmode == 0) mode = 0; //Reinicia o modo.
    switch (mode)
    {
      case 0: // Nenhum modo selecionado

        Serial.print("Escolha o modo\n"); // TEST PROTOBOARD

        //PRINTAR: ESCOLHA O MODO
        //         L:MANUAL R:AUTO
        if (right == 0) {
          Serial.print("Direita Escolhido\n"); // TEST PROTOBOARD
          mode = 1;
          locus = posicao;
        }
        if (left == 0) {
          Serial.print("Esquerda Escolhido\n"); // TEST PROTOBOARD
          mode = 2;
        }
        delay(500);
        break;

      // -----------------------------------------------------------= Modo Automático =---------------------------------------------------

      case 1: // Modo Automático
        if (right == 0 and locus < Max)
        {
          locus = locus + resolution;

          Serial.print("DireitaA locus = "); // TEST PROTOBOARD
          Serial.print(locus); // TEST PROTOBOARD
          Serial.print("\n"); //TEST PROTOBOARD
          delay(velocidade_botton);
        }
        else if (left == 0 and locus > 1)
        {
          locus = locus - resolution;
          Serial.print("EsquerdaA locus = "); // TEST PROTOBOARD
          Serial.print(locus); // TEST PROTOBOARD
          Serial.print("\n"); //TEST PROTOBOARD
          delay(velocidade_botton);
        }
        else if (go == 0)
        {
          while (posicao < locus) // Vai para a direita
          {
            posicao = posicao + resolution;
            //PRINTAR: Locus: (locus)
            //         Position: (posicao)

            //stepper.step(1); // Vai para a direita

            Serial.print("Direita  \n"); // TEST PROTOBOARD
            delay(velocidade_botton); // TEST PROTOBOARD
          }
          while (posicao > locus)
          {
            posicao = posicao - resolution;
            //PRINTAR: Locus: (locus)
            //         Position: (posicao)

            //stepper.step(-1); // Vai para a esquerda

            Serial.print("Esquerda  \n"); // TEST PROTOBOARD
            delay(velocidade_botton);
          }
        }
        else
        {
          //PRINT Impossible
          //      Operacion!
        }
        break;

      // -------------------------------------------------------------= Modo Manual =-----------------------------------------------------

      case 2: // Modo Manual

        //PRINTAR: Position: (posicao)
        //         Máximo : (Max)

        if (right == 0 and digitalRead(fcr) == HIGH)
        {
          posicao = posicao + resolution;
          //stepper.step(1);

          //PRINTAR: Position: (posicao)
          //         Máximo : (Max)

          Serial.print("Direita  \n"); // TEST PROTOBOARD
          delay(velocidade_botton); // TEST PROTOBOARD
        }
        else if (left == 0 and digitalRead(fcl) == HIGH)
        {
          posicao = posicao - resolution;
          //stepper.step(-1);

          //PRINTAR: Position: (posicao)
          //         Máximo : (Max)

          Serial.print("Esquerda  \n"); // TEST PROTOBOARD
          delay(velocidade_botton); // TEST PROTOBOARD
        }
        else
        {
          //PRINT Impossible
          //      Operacion!
        }
        break;
    }
  }
  right = 1;
  left = 1;
  go = 1;
  bmode = 1;

  right = botton_status(botton_right, status_br);
  left = botton_status(botton_left, status_bl);
  go = botton_status(botton_go, status_go);
  bmode = botton_status(botton_mode, status_mode);
}
